# Vite 插件钩子执行顺序与用途

## Vite 插件系统概述

Vite 的核心架构依赖于其强大而灵活的插件系统。Vite 本身是轻量级的，大部分功能都通过插件实现，包括对各种文件类型的支持、代码转换、构建优化等。Vite 使用了与 Rollup 兼容的插件接口，并添加了一些 Vite 特有的扩展。

### Vite 如何通过插件实现功能

1. **模块化功能实现**：Vite 将不同功能拆分到不同插件中，使核心保持简洁
2. **可扩展性**：用户可以通过添加或配置插件来扩展 Vite 的功能
3. **生命周期控制**：通过各种钩子函数，插件可以在构建过程的不同阶段介入
4. **代码转换**：插件可以处理不同类型的文件，进行代码转换和优化

### Vite 内置的插件

Vite 内部使用了许多插件来提供基础功能：

- `@vitejs/plugin-vue`: 提供 Vue 单文件组件支持
- `@vitejs/plugin-react`: 提供 React 支持
- `@vitejs/plugin-legacy`: 为旧版浏览器提供兼容性支持

## 插件钩子的应用场景分类

Vite 插件钩子可以根据应用场景分为以下几类：

| 钩子类别 | 开发服务器 (Dev) | 生产构建 (Build) | 两者都有 |
|---------|----------------|----------------|---------|
| `config` | ✅ | ✅ | ✅ |
| `configResolved` | ✅ | ✅ | ✅ |
| `configureServer` | ✅ | ❌ | ❌ |
| `buildStart` | ✅ | ✅ | ✅ |
| `resolveId` | ✅ | ✅ | ✅ |
| `load` | ✅ | ✅ | ✅ |
| `transform` | ✅ | ✅ | ✅ |
| `transformIndexHtml` | ✅ | ✅ | ✅ |
| `handleHotUpdate` | ✅ | ❌ | ❌ |
| `buildEnd` | ✅ | ✅ | ✅ |
| `closeBundle` | ❌ | ✅ | ❌ |

## 构建阶段钩子 (Build Hooks)

### 1. `config`

**执行时机**：在解析 Vite 配置前调用。
**用途**：
- 修改、扩展 Vite 配置
- 返回部分配置与用户配置合并
- 常用于添加自定义配置、修改默认设置等

### 2. `configResolved`

**执行时机**：在 Vite 配置解析完成后调用。
**用途**：
- 读取和存储最终解析的配置
- 在其他钩子中使用这些配置
- 用于在插件中保存配置引用，避免重复计算

### 3. `configureServer`

**执行时机**：在开发服务器启动时被调用。
**用途**：
- 配置开发服务器
- 添加自定义中间件
- 处理特定的服务请求
- 常用于添加自定义服务器功能，如模拟 API 数据等

### 4. `buildStart`

**执行时机**：在每次构建开始时调用。
**用途**：
- 初始化构建资源
- 设置构建过程中需要使用的状态
- 常用于准备工作，如创建缓存、初始化变量等

## 文件处理钩子 (File Processing Hooks)

### 5. `resolveId`

**执行时机**：在解析模块 ID 时调用。
**用途**：
- 自定义模块解析逻辑
- 为虚拟模块提供解析路径
- 常用于处理别名、自定义模块导入等

### 6. `load`

**执行时机**：在加载模块时调用。
**用途**：
- 返回自定义的模块内容
- 加载虚拟模块
- 常用于生成代码、提供虚拟模块内容等

### 7. `transform`

**执行时机**：在转换模块代码时调用。
**用途**：
- 转换源代码
- 添加或移除代码
- 常用于代码注入、TypeScript 转换、预处理器等

### 8. `transformIndexHtml`

**执行时机**：在处理 HTML 时调用。
**用途**：
- 转换 HTML 内容
- 注入脚本或样式标签
- 常用于向 HTML 中添加环境变量、分析工具、自定义脚本等

## 热更新相关钩子 (HMR Hooks)

### 9. `handleHotUpdate`

**执行时机**：在热更新模块时调用。
**用途**：
- 自定义热更新处理逻辑
- 过滤需要更新的模块
- 发送自定义更新事件
- 常用于优化热更新性能、自定义热更新行为等

## 构建结束钩子 (Build Completion Hooks)

### 10. `buildEnd`

**执行时机**：在构建结束时调用，无论成功还是失败。
**用途**：
- 清理资源
- 输出构建统计信息
- 常用于释放资源、日志记录等

### 11. `closeBundle`

**执行时机**：在构建完成后，所有打包操作完成时调用。
**用途**：
- 执行最终的清理操作
- 生成额外的文件和报告
- 常用于生成构建报告、部署通知等

## 注意事项

1. 不同的钩子在不同的构建阶段被调用，有些只在开发服务器模式下调用（如 `configureServer`、`handleHotUpdate`），有些在所有模式下都会调用。
2. 钩子函数可以是同步或异步的，建议使用 async/await 处理异步钩子。
3. 某些钩子函数（如 `resolveId`、`load`、`transform`）的返回值会影响构建流程。
4. 插件的顺序很重要，因为它决定了钩子的执行顺序。
5. `closeBundle` 钩子主要在生产构建时使用，用于执行打包后的操作。
6. 开发服务器特有的钩子（如 `configureServer`、`handleHotUpdate`）在生产构建时不会被调用。

通过合理利用这些钩子，可以开发出功能强大的 Vite 插件，满足各种自定义构建需求。
